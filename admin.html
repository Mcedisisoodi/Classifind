<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Admin Panel â€“ HoneySweetpot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <script type="module" src="app.js"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        .admin-table th, .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .admin-table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        .admin-table tr:hover {
            background-color: #f5f5f5;
        }
        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
        }
        .edit-btn {
            background-color: #ffca28;
            color: #333;
        }
        .delete-btn {
            background-color: #c62828;
            color: #fff;
        }
        /* Modal Styles - Removed as we now redirect to post-ad.html for editing */
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="index.html" style="text-decoration:none; color:inherit;">Honey<span>Sweetpot</span> <img src="/categories/HoneyPot.webp" alt="HoneySweetpot Logo" style="height: 60px; vertical-align: bottom; margin-left: 5px;"></a></div>
        <div class="header-actions">
            <a href="index.html" class="btn">Back to Home</a>
        </div>
    </header>
    <main>
        <div id="loadingMsg" style="text-align:center; margin-top:50px;">Checking permissions...</div>
        
        <div id="adminContent" class="admin-container" style="display:none;">
            <div class="admin-header">
                <h2>Admin Dashboard</h2>
                <span id="adminEmail" style="color: #666;"></span>
            </div>
            
            <div style="overflow-x:auto;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Seller</th>
                            <th>Posted</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adsTableBody">
                        <!-- Rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Edit Modal Removed -->

    <!-- History Modal -->
    <div id="historyModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 800px; position: relative;">
            <button id="closeHistoryX" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h3>Ad Edit History</h3>
            <div id="historyContent" style="max-height: 60vh; overflow-y: auto;">
                <!-- History items will be populated here -->
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button type="button" class="btn" id="closeHistory">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabaseClient, getSession, signOut } from './app.js';

        const ADMIN_EMAIL = "Compsody@gmail.com";
        const loadingMsg = document.getElementById("loadingMsg");
        const adminContent = document.getElementById("adminContent");
        const adsTableBody = document.getElementById("adsTableBody");
        const historyModal = document.getElementById("historyModal");
        const historyContent = document.getElementById("historyContent");

        // Check Auth
        async function checkAdmin() {
            const session = await getSession();
            if (!session || !session.user.email || session.user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                loadingMsg.textContent = "Access Denied. You are not authorized to view this page.";
                loadingMsg.style.color = "red";
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 2000);
                return;
            }

            document.getElementById("adminEmail").textContent = session.user.email;
            loadingMsg.style.display = "none";
            adminContent.style.display = "block";
            fetchAds();
        }

        // Fetch Ads
        async function fetchAds() {
            adsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading ads...</td></tr>';
            
            const { data: ads, error } = await supabaseClient
                .from('ads')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                alert("Error fetching ads: " + error.message);
                return;
            }

            renderAds(ads);
        }

        // Render Ads
        function renderAds(ads) {
            adsTableBody.innerHTML = "";
            if (ads.length === 0) {
                adsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No ads found.</td></tr>';
                return;
            }

            ads.forEach(ad => {
                const tr = document.createElement("tr");
                
                // Image handling
                let imgUrl = ad.image_url;
                if (ad.images && ad.images.length > 0) imgUrl = ad.images[0];
                if (!imgUrl) imgUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'%3E%3Crect width='50' height='50' fill='%23eee'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='10'%3ENo Img%3C/text%3E%3C/svg%3E";

                // Status Logic
                let statusHtml = "";
                if (ad.deleted) {
                    statusHtml = '<span style="color:red; font-weight:bold;">Deleted by User</span>';
                    if (ad.updated_at) {
                        statusHtml += `<br><small style="color:#666;">${new Date(ad.updated_at).toLocaleDateString()} ${new Date(ad.updated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>`;
                    }
                } else if (ad.sold) {
                    statusHtml = '<span style="color:gray; font-weight:bold;">Sold</span>';
                    if (ad.updated_at) {
                        statusHtml += `<br><small style="color:#666;">${new Date(ad.updated_at).toLocaleDateString()} ${new Date(ad.updated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>`;
                    }
                } else if (ad.hidden) {
                    statusHtml = '<span style="color:orange; font-weight:bold;">Hidden</span>';
                } else {
                    statusHtml = '<span style="color:green;">Active</span>';
                }

                // Edited Check - Only show if NOT sold and NOT deleted
                if (!ad.sold && !ad.deleted && ad.updated_at && ad.created_at && new Date(ad.updated_at) > new Date(ad.created_at)) {
                    const editedDate = new Date(ad.updated_at).toLocaleDateString() + ' ' + new Date(ad.updated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    statusHtml += `<br><small style="color:#666;">Edited: ${editedDate}</small>`;
                }

                tr.innerHTML = `
                    <td><img src="${imgUrl}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;"></td>
                    <td>${ad.title}</td>
                    <td>${ad.category}</td>
                    <td>R ${Number(ad.price).toLocaleString()}</td>
                    <td>${ad.seller_name || "Unknown"}</td>
                    <td>${new Date(ad.created_at).toLocaleDateString()}</td>
                    <td>${statusHtml}</td>
                    <td>
                        <button class="action-btn edit-btn" data-id="${ad.id}" ${ad.deleted ? 'disabled' : ''}>Edit</button>
                        <button class="action-btn history-btn" data-id="${ad.id}" style="background-color: #007bff; color: #fff;">History</button>
                        <button class="action-btn hide-btn" data-id="${ad.id}" data-hidden="${ad.hidden}" style="background-color: #555; color: #fff;" ${ad.deleted ? 'disabled' : ''}>${ad.hidden ? 'Unhide' : 'Hide'}</button>
                        <button class="action-btn delete-btn" data-id="${ad.id}" data-deleted="${ad.deleted}">Delete</button>
                    </td>
                `;
                adsTableBody.appendChild(tr);
            });

            // Attach event listeners
            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", () => deleteAd(btn.dataset.id, btn.dataset.deleted === 'true'));
            });
            document.querySelectorAll(".edit-btn").forEach(btn => {
                if (!btn.disabled) btn.addEventListener("click", () => openEditModal(btn.dataset.id));
            });
            document.querySelectorAll(".hide-btn").forEach(btn => {
                if (!btn.disabled) btn.addEventListener("click", () => toggleHide(btn.dataset.id, btn.dataset.hidden === 'true'));
            });
            document.querySelectorAll(".history-btn").forEach(btn => {
                btn.addEventListener("click", () => openHistoryModal(btn.dataset.id));
            });
        }

        // Open History Modal
        async function openHistoryModal(id) {
            historyContent.innerHTML = '<p style="text-align:center;">Loading history...</p>';
            historyModal.style.display = "flex";

            // Fetch current ad
            const { data: currentAd, error: adError } = await supabaseClient
                .from('ads')
                .select('*')
                .eq('id', id)
                .single();

            if (adError) {
                historyContent.innerHTML = `<p style="color:red;">Error loading ad: ${adError.message}</p>`;
                return;
            }

            // Fetch history
            const { data: history, error: histError } = await supabaseClient
                .from('ad_history')
                .select('*')
                .eq('ad_id', id)
                .order('changed_at', { ascending: false });

            if (histError) {
                historyContent.innerHTML = `<p style="color:red;">Error loading history: ${histError.message}</p>`;
                return;
            }

            if (history.length === 0) {
                historyContent.innerHTML = '<p style="text-align:center;">No edit history found for this ad.</p>';
                return;
            }

            renderHistory(currentAd, history);
        }

        function renderHistory(currentAd, history) {
            let html = "";
            
            // Compare Current vs Latest History (if any)
            // Actually, let's just list them chronologically: Current State, then History 1, History 2...
            
            html += `
                <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 4px; background: #e8f5e9;">
                    <h4 style="margin-top:0;">Current Version (Now)</h4>
                    <p><strong>Title:</strong> ${currentAd.title}</p>
                    <p><strong>Price:</strong> R ${Number(currentAd.price).toLocaleString()}</p>
                    <p><strong>Description:</strong> ${currentAd.description}</p>
                    <p><strong>Category:</strong> ${currentAd.category}</p>
                    <p><strong>Condition:</strong> ${currentAd.condition}</p>
                    <p><strong>Location:</strong> ${currentAd.location}</p>
                </div>
            `;

            history.forEach((ver, index) => {
                const date = new Date(ver.changed_at).toLocaleString();
                html += `
                    <div style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #fafafa;">
                        <h4 style="margin-top:0; color: #666;">Previous Version (${date})</h4>
                        <p><strong>Title:</strong> ${ver.title}</p>
                        <p><strong>Price:</strong> R ${Number(ver.price).toLocaleString()}</p>
                        <p><strong>Description:</strong> ${ver.description}</p>
                        <p><strong>Category:</strong> ${ver.category}</p>
                        <p><strong>Condition:</strong> ${ver.condition}</p>
                        <p><strong>Location:</strong> ${ver.location}</p>
                    </div>
                `;
            });

            historyContent.innerHTML = html;
        }

        document.getElementById("closeHistory").addEventListener("click", () => {
            historyModal.style.display = "none";
        });
        document.getElementById("closeHistoryX").addEventListener("click", () => {
            historyModal.style.display = "none";
        });
        window.addEventListener("click", (e) => {
            if (e.target === historyModal) {
                historyModal.style.display = "none";
            }
        });

        // Toggle Hide
        async function toggleHide(id, isHidden) {
            const { error } = await supabaseClient
                .from('ads')
                .update({ hidden: !isHidden, updated_at: new Date() })
                .eq('id', id);

            if (error) {
                alert("Error updating ad status: " + error.message);
            } else {
                fetchAds();
            }
        }

        // Delete Ad (Soft or Hard Delete)
        async function deleteAd(id, isAlreadyDeleted) {
            if (isAlreadyDeleted) {
                if (!confirm("This ad is already marked as 'Deleted by User'.\n\nDo you want to PERMANENTLY delete this record from the database?\nThis action cannot be undone.")) return;
                
                const { error } = await supabaseClient
                    .from('ads')
                    .delete()
                    .eq('id', id);

                if (error) {
                    alert("Error permanently deleting ad: " + error.message);
                } else {
                    fetchAds();
                }
            } else {
                if (!confirm("Are you sure you want to delete this ad? (Soft Delete)")) return;

                const { error } = await supabaseClient
                    .from('ads')
                    .update({ deleted: true, updated_at: new Date() }) // Soft delete
                    .eq('id', id);

                if (error) {
                    alert("Error deleting ad: " + error.message);
                } else {
                    fetchAds(); // Refresh list
                }
            }
        }

        // Edit Ad - Redirect to post-ad.html with from=admin
        function openEditModal(id) {
            window.location.href = `post-ad.html?id=${id}&from=admin`;
        }


        // Init
        checkAdmin();
    </script>
</body>
</html>
