<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Admin Panel â€“ HoneySweetpot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <script type="module" src="app.js"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        .admin-table th, .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .admin-table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        .admin-table tr:hover {
            background-color: #f5f5f5;
        }
        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
        }
        .edit-btn {
            background-color: #ffca28;
            color: #333;
        }
        .delete-btn {
            background-color: #c62828;
            color: #fff;
        }
        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="index.html" style="text-decoration:none; color:inherit;">Honey<span>Sweetpot</span> <img src="/categories/HoneyPot.webp" alt="HoneySweetpot Logo" style="height: 60px; vertical-align: bottom; margin-left: 5px;"></a></div>
        <div class="header-actions">
            <a href="index.html" class="btn">Back to Home</a>
            <button class="btn" id="logoutBtn">Logout</button>
        </div>
    </header>
    <main>
        <div id="loadingMsg" style="text-align:center; margin-top:50px;">Checking permissions...</div>
        
        <div id="adminContent" class="admin-container" style="display:none;">
            <div class="admin-header">
                <h2>Admin Dashboard</h2>
            </div>
            
            <div style="overflow-x:auto;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Seller</th>
                            <th>Posted</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adsTableBody">
                        <!-- Rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-backdrop">
        <div class="modal-content" style="position: relative;">
            <button id="closeEditX" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h3>Edit Ad</h3>
            <form id="editForm">
                <input type="hidden" id="editId">
                
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="editTitle" required>
                </div>
                
                <div class="form-group">
                    <label>Price (R)</label>
                    <input type="number" id="editPrice" required>
                </div>
                
                <div class="form-group">
                    <label>Category</label>
                    <select id="editCategory" required>
                        <option value="Cars">Cars</option>
                        <option value="Properties">Properties</option>
                        <option value="Phones">Phones</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Jobs">Jobs</option>
                        <option value="Services">Services</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Sports">Sports</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Condition</label>
                    <select id="editCondition">
                        <option value="New">New</option>
                        <option value="Used">Used</option>
                        <option value="Refurbished">Refurbished</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="editLocation" required>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editDescription" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label>Current Images</label>
                    <div id="editImagesContainer" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
                </div>

                <div class="form-group">
                    <label>Add Images</label>
                    <input type="file" id="editImageUpload" multiple accept="image/*">
                </div>

                <div style="text-align:right; margin-top:20px;">
                    <button type="button" class="btn" id="cancelEdit" style="background:#ccc; color:#333; margin-right:10px;">Cancel</button>
                    <button type="submit" class="btn" style="background:#ffca28; color:#333;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 800px; position: relative;">
            <button id="closeHistoryX" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h3>Ad Edit History</h3>
            <div id="historyContent" style="max-height: 60vh; overflow-y: auto;">
                <!-- History items will be populated here -->
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button type="button" class="btn" id="closeHistory">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabaseClient, getSession, signOut } from './app.js';

        const ADMIN_EMAIL = "Compsody@gmail.com";
        const loadingMsg = document.getElementById("loadingMsg");
        const adminContent = document.getElementById("adminContent");
        const adsTableBody = document.getElementById("adsTableBody");
        const editModal = document.getElementById("editModal");
        const editForm = document.getElementById("editForm");
        const historyModal = document.getElementById("historyModal");
        const historyContent = document.getElementById("historyContent");
        let currentEditImages = [];

        // Check Auth
        async function checkAdmin() {
            const session = await getSession();
            if (!session || !session.user.email || session.user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                loadingMsg.textContent = "Access Denied. You are not authorized to view this page.";
                loadingMsg.style.color = "red";
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 2000);
                return;
            }

            document.getElementById("adminEmail").textContent = session.user.email;
            loadingMsg.style.display = "none";
            adminContent.style.display = "block";
            fetchAds();
        }

        // Fetch Ads
        async function fetchAds() {
            adsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading ads...</td></tr>';
            
            const { data: ads, error } = await supabaseClient
                .from('ads')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                alert("Error fetching ads: " + error.message);
                return;
            }

            renderAds(ads);
        }

        // Render Ads
        function renderAds(ads) {
            adsTableBody.innerHTML = "";
            if (ads.length === 0) {
                adsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No ads found.</td></tr>';
                return;
            }

            ads.forEach(ad => {
                const tr = document.createElement("tr");
                
                // Image handling
                let imgUrl = ad.image_url;
                if (ad.images && ad.images.length > 0) imgUrl = ad.images[0];
                if (!imgUrl) imgUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'%3E%3Crect width='50' height='50' fill='%23eee'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='10'%3ENo Img%3C/text%3E%3C/svg%3E";

                // Status Logic
                let statusHtml = "";
                if (ad.deleted) {
                    statusHtml = '<span style="color:red; font-weight:bold;">Deleted by User</span>';
                    if (ad.updated_at) {
                        statusHtml += `<br><small style="color:#666;">${new Date(ad.updated_at).toLocaleDateString()} ${new Date(ad.updated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>`;
                    }
                } else if (ad.sold) {
                    statusHtml = '<span style="color:gray; font-weight:bold;">Sold</span>';
                    if (ad.updated_at) {
                        statusHtml += `<br><small style="color:#666;">${new Date(ad.updated_at).toLocaleDateString()} ${new Date(ad.updated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>`;
                    }
                } else if (ad.hidden) {
                    statusHtml = '<span style="color:orange; font-weight:bold;">Hidden</span>';
                } else {
                    statusHtml = '<span style="color:green;">Active</span>';
                }

                // Edited Check - Only show if NOT sold and NOT deleted
                if (!ad.sold && !ad.deleted && ad.updated_at && ad.created_at && new Date(ad.updated_at) > new Date(ad.created_at)) {
                    const editedDate = new Date(ad.updated_at).toLocaleDateString() + ' ' + new Date(ad.updated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    statusHtml += `<br><small style="color:#666;">Edited: ${editedDate}</small>`;
                }

                tr.innerHTML = `
                    <td><img src="${imgUrl}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;"></td>
                    <td>${ad.title}</td>
                    <td>${ad.category}</td>
                    <td>R ${Number(ad.price).toLocaleString()}</td>
                    <td>${ad.seller_name || "Unknown"}</td>
                    <td>${new Date(ad.created_at).toLocaleDateString()}</td>
                    <td>${statusHtml}</td>
                    <td>
                        <button class="action-btn edit-btn" data-id="${ad.id}" ${ad.deleted ? 'disabled' : ''}>Edit</button>
                        <button class="action-btn history-btn" data-id="${ad.id}" style="background-color: #007bff; color: #fff;">History</button>
                        <button class="action-btn hide-btn" data-id="${ad.id}" data-hidden="${ad.hidden}" style="background-color: #555; color: #fff;" ${ad.deleted ? 'disabled' : ''}>${ad.hidden ? 'Unhide' : 'Hide'}</button>
                        <button class="action-btn delete-btn" data-id="${ad.id}" data-deleted="${ad.deleted}">Delete</button>
                    </td>
                `;
                adsTableBody.appendChild(tr);
            });

            // Attach event listeners
            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", () => deleteAd(btn.dataset.id, btn.dataset.deleted === 'true'));
            });
            document.querySelectorAll(".edit-btn").forEach(btn => {
                if (!btn.disabled) btn.addEventListener("click", () => openEditModal(btn.dataset.id));
            });
            document.querySelectorAll(".hide-btn").forEach(btn => {
                if (!btn.disabled) btn.addEventListener("click", () => toggleHide(btn.dataset.id, btn.dataset.hidden === 'true'));
            });
            document.querySelectorAll(".history-btn").forEach(btn => {
                btn.addEventListener("click", () => openHistoryModal(btn.dataset.id));
            });
        }

        // Open History Modal
        async function openHistoryModal(id) {
            historyContent.innerHTML = '<p style="text-align:center;">Loading history...</p>';
            historyModal.style.display = "flex";

            // Fetch current ad
            const { data: currentAd, error: adError } = await supabaseClient
                .from('ads')
                .select('*')
                .eq('id', id)
                .single();

            if (adError) {
                historyContent.innerHTML = `<p style="color:red;">Error loading ad: ${adError.message}</p>`;
                return;
            }

            // Fetch history
            const { data: history, error: histError } = await supabaseClient
                .from('ad_history')
                .select('*')
                .eq('ad_id', id)
                .order('changed_at', { ascending: false });

            if (histError) {
                historyContent.innerHTML = `<p style="color:red;">Error loading history: ${histError.message}</p>`;
                return;
            }

            if (history.length === 0) {
                historyContent.innerHTML = '<p style="text-align:center;">No edit history found for this ad.</p>';
                return;
            }

            renderHistory(currentAd, history);
        }

        function renderHistory(currentAd, history) {
            let html = "";
            
            // Compare Current vs Latest History (if any)
            // Actually, let's just list them chronologically: Current State, then History 1, History 2...
            
            html += `
                <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 4px; background: #e8f5e9;">
                    <h4 style="margin-top:0;">Current Version (Now)</h4>
                    <p><strong>Title:</strong> ${currentAd.title}</p>
                    <p><strong>Price:</strong> R ${Number(currentAd.price).toLocaleString()}</p>
                    <p><strong>Description:</strong> ${currentAd.description}</p>
                    <p><strong>Category:</strong> ${currentAd.category}</p>
                    <p><strong>Condition:</strong> ${currentAd.condition}</p>
                    <p><strong>Location:</strong> ${currentAd.location}</p>
                </div>
            `;

            history.forEach((ver, index) => {
                const date = new Date(ver.changed_at).toLocaleString();
                html += `
                    <div style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #fafafa;">
                        <h4 style="margin-top:0; color: #666;">Previous Version (${date})</h4>
                        <p><strong>Title:</strong> ${ver.title}</p>
                        <p><strong>Price:</strong> R ${Number(ver.price).toLocaleString()}</p>
                        <p><strong>Description:</strong> ${ver.description}</p>
                        <p><strong>Category:</strong> ${ver.category}</p>
                        <p><strong>Condition:</strong> ${ver.condition}</p>
                        <p><strong>Location:</strong> ${ver.location}</p>
                    </div>
                `;
            });

            historyContent.innerHTML = html;
        }

        document.getElementById("closeHistory").addEventListener("click", () => {
            historyModal.style.display = "none";
        });
        document.getElementById("closeHistoryX").addEventListener("click", () => {
            historyModal.style.display = "none";
        });
        window.addEventListener("click", (e) => {
            if (e.target === historyModal) {
                historyModal.style.display = "none";
            }
            if (e.target === editModal) {
                editModal.style.display = "none";
            }
        });

        // Toggle Hide
        async function toggleHide(id, isHidden) {
            const { error } = await supabaseClient
                .from('ads')
                .update({ hidden: !isHidden, updated_at: new Date() })
                .eq('id', id);

            if (error) {
                alert("Error updating ad status: " + error.message);
            } else {
                fetchAds();
            }
        }

        // Delete Ad (Soft or Hard Delete)
        async function deleteAd(id, isAlreadyDeleted) {
            if (isAlreadyDeleted) {
                if (!confirm("This ad is already marked as 'Deleted by User'.\n\nDo you want to PERMANENTLY delete this record from the database?\nThis action cannot be undone.")) return;
                
                const { error } = await supabaseClient
                    .from('ads')
                    .delete()
                    .eq('id', id);

                if (error) {
                    alert("Error permanently deleting ad: " + error.message);
                } else {
                    fetchAds();
                }
            } else {
                if (!confirm("Are you sure you want to delete this ad? (Soft Delete)")) return;

                const { error } = await supabaseClient
                    .from('ads')
                    .update({ deleted: true, updated_at: new Date() }) // Soft delete
                    .eq('id', id);

                if (error) {
                    alert("Error deleting ad: " + error.message);
                } else {
                    fetchAds(); // Refresh list
                }
            }
        }

        // Edit Ad
        async function openEditModal(id) {
            const { data: ad, error } = await supabaseClient
                .from('ads')
                .select('*')
                .eq('id', id)
                .single();

            if (error) {
                alert("Error loading ad details: " + error.message);
                return;
            }

            document.getElementById("editId").value = ad.id;
            document.getElementById("editTitle").value = ad.title;
            document.getElementById("editPrice").value = ad.price;
            document.getElementById("editCategory").value = ad.category;
            document.getElementById("editCondition").value = ad.condition || "Used";
            document.getElementById("editLocation").value = ad.location;
            document.getElementById("editDescription").value = ad.description;

            // Handle Images
            currentEditImages = ad.images || (ad.image_url ? [ad.image_url] : []);
            renderEditImages();

            editModal.style.display = "flex";
        }

        function renderEditImages() {
            const container = document.getElementById("editImagesContainer");
            container.innerHTML = "";
            currentEditImages.forEach((url, index) => {
                const div = document.createElement("div");
                div.style.position = "relative";
                div.style.width = "80px";
                div.style.height = "80px";
                
                const img = document.createElement("img");
                img.src = url;
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.objectFit = "cover";
                img.style.borderRadius = "4px";
                
                const btn = document.createElement("button");
                btn.innerHTML = "&times;";
                btn.style.position = "absolute";
                btn.style.top = "-5px";
                btn.style.right = "-5px";
                btn.style.background = "red";
                btn.style.color = "white";
                btn.style.border = "none";
                btn.style.borderRadius = "50%";
                btn.style.width = "20px";
                btn.style.height = "20px";
                btn.style.cursor = "pointer";
                btn.onclick = (e) => {
                    e.preventDefault();
                    currentEditImages.splice(index, 1);
                    renderEditImages();
                };
                
                div.appendChild(img);
                div.appendChild(btn);
                container.appendChild(div);
            });
        }

        // Save Edit
        editForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("editId").value;
            const submitBtn = editForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = "Saving...";

            // Upload new images
            const fileInput = document.getElementById("editImageUpload");
            const newFiles = Array.from(fileInput.files);
            
            if (newFiles.length > 0) {
                try {
                    const uploadPromises = newFiles.map(async (file) => {
                        const fileExt = file.name.split(".").pop();
                        const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.${fileExt}`;
                        const filePath = `ads/${fileName}`;
                        
                        const { data, error } = await supabaseClient
                            .storage
                            .from("ad-images")
                            .upload(filePath, file);
                        
                        if (error) throw error;

                        const { data: publicUrlData } = supabaseClient
                            .storage
                            .from("ad-images")
                            .getPublicUrl(filePath);
                        
                        return publicUrlData.publicUrl;
                    });

                    const newUrls = await Promise.all(uploadPromises);
                    currentEditImages = [...currentEditImages, ...newUrls];
                } catch (err) {
                    console.error("Upload error:", err);
                    alert("Failed to upload some images: " + err.message);
                }
            }

            const updates = {
                title: document.getElementById("editTitle").value,
                price: document.getElementById("editPrice").value,
                category: document.getElementById("editCategory").value,
                condition: document.getElementById("editCondition").value,
                location: document.getElementById("editLocation").value,
                description: document.getElementById("editDescription").value,
                images: currentEditImages,
                image_url: currentEditImages.length > 0 ? currentEditImages[0] : null, // Update legacy column
                updated_at: new Date()
            };

            const { error } = await supabaseClient
                .from('ads')
                .update(updates)
                .eq('id', id);

            submitBtn.disabled = false;
            submitBtn.textContent = "Save Changes";

            if (error) {
                alert("Error updating ad: " + error.message);
            } else {
                editModal.style.display = "none";
                fetchAds();
            }
        });

        document.getElementById("cancelEdit").addEventListener("click", () => {
            editModal.style.display = "none";
        });
        document.getElementById("closeEditX").addEventListener("click", () => {
            editModal.style.display = "none";
        });

        document.getElementById("logoutBtn").addEventListener("click", async () => {
            await signOut();
            window.location.href = "index.html";
        });

        // Init
        checkAdmin();
    </script>
</body>
</html>
