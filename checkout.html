<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Secure Checkout ‚Äì HoneyPot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <script type="module" src="app.js"></script>
</head>
<body>
    <header>
        <div class="logo"><a href="index.html" style="text-decoration:none; color:inherit;">Honey<span>Pot</span></a></div>
        <div class="header-actions">
            <span style="color:#fff; font-size:0.9rem;">Secure Checkout üîí</span>
        </div>
    </header>
    <main>
        <div class="checkout-container">
            <div class="checkout-left">
                <!-- 1. Delivery Address -->
                <section class="checkout-section">
                    <h2 class="checkout-title">1. Delivery Address</h2>
                    <div class="address-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Street Address</label>
                                <input type="text" id="addrStreet" placeholder="e.g. 123 Main Road" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Suburb</label>
                                <input type="text" id="addrSuburb" placeholder="e.g. Sandton" />
                            </div>
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="addrCity" placeholder="e.g. Johannesburg" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Province</label>
                                <select id="addrProvince">
                                    <option value="">Select Province</option>
                                    <option value="Gauteng">Gauteng</option>
                                    <option value="Western Cape">Western Cape</option>
                                    <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                                    <option value="Eastern Cape">Eastern Cape</option>
                                    <option value="Free State">Free State</option>
                                    <option value="North West">North West</option>
                                    <option value="Limpopo">Limpopo</option>
                                    <option value="Mpumalanga">Mpumalanga</option>
                                    <option value="Northern Cape">Northern Cape</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Postal Code</label>
                                <input type="text" id="addrCode" placeholder="e.g. 2196" />
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. Payment Method -->
                <section class="checkout-section">
                    <h2 class="checkout-title">2. Payment Method</h2>
                    <div class="form-group">
                        <label for="paymentMethodSelect" style="display:block; margin-bottom:8px; color:#555; font-size:0.9rem;">Choose your preferred payment option</label>
                        <select id="paymentMethodSelect" class="payment-select">
                            <option value="" disabled selected>Select Payment Method</option>
                            <option value="Visa">Visa / Mastercard</option>
                            <option value="SnapScan">SnapScan</option>
                            <option value="Ozow">Ozow Instant EFT</option>
                            <option value="Capitec Pay">Capitec Pay</option>
                            <option value="Zapper">Zapper</option>
                            <option value="Payflex">Payflex</option>
                            <option value="eBucks">eBucks</option>
                            <option value="Discovery Miles">Discovery Miles</option>
                            <option value="EFT">EFT / Bank Transfer</option>
                            <option value="Mobicred">Mobicred</option>
                        </select>
                    </div>
                    <div class="payment-icons-preview">
                        <span>üí≥</span> <span>üì±</span> <span>‚ö°</span> <span>üè¶</span> <span>üì≤</span> <span>üïí</span> <span>üí∞</span> <span>üíé</span>
                    </div>
                </section>
            </div>

            <div class="checkout-right">
                <div class="order-summary">
                    <h3>My Cart</h3>
                    <div id="orderItem" class="order-item">
                        <div class="order-img-skeleton"></div>
                        <div class="order-details-skeleton">
                            <div class="sk-line"></div>
                            <div class="sk-line short"></div>
                        </div>
                    </div>
                    <div class="order-totals">
                        <div class="total-row">
                            <span>Subtotal</span>
                            <span id="subtotalAmount">R 0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Delivery</span>
                            <span>R 99.00</span>
                        </div>
                        <div class="total-row final">
                            <span>Total</span>
                            <span id="totalAmount">R 99.00</span>
                        </div>
                    </div>
                    <button id="payBtn" class="btn-pay">Pay Now</button>
                    <p class="secure-note">üîí Your data is secure and encrypted</p>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { supabaseClient } from './app.js';

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const orderItem = document.getElementById('orderItem');
        const subtotalAmount = document.getElementById('subtotalAmount');
        const totalAmount = document.getElementById('totalAmount');
        const payBtn = document.getElementById('payBtn');
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='24' fill='%23666666'%3ENo Image%3C/text%3E%3C/svg%3E";

        async function loadOrder() {
            if (!id) {
                alert("No item selected.");
                window.location.href = "index.html";
                return;
            }

            const { data: ad, error } = await supabaseClient
                .from('ads')
                .select('*')
                .eq('id', id)
                .single();

            if (error || !ad) {
                alert("Item not found.");
                window.location.href = "index.html";
                return;
            }

            // Determine image
            let imgUrl = ad.image_url || PLACEHOLDER_IMG;
            if (ad.images && ad.images.length > 0) imgUrl = ad.images[0];

            const price = ad.price || 0;
            const delivery = 99;
            const total = price + delivery;

            // Render Item
            orderItem.innerHTML = `
                <img src="${imgUrl}" alt="${ad.title}" class="order-img" />
                <div class="order-info">
                    <h4>${ad.title}</h4>
                    <p>${ad.condition || 'Used'}</p>
                    <p class="order-price">R ${price.toLocaleString()}</p>
                </div>
            `;

            subtotalAmount.textContent = `R ${price.toLocaleString()}`;
            totalAmount.textContent = `R ${total.toLocaleString()}`;
        }

        payBtn.addEventListener('click', () => {
            const street = document.getElementById('addrStreet').value;
            const city = document.getElementById('addrCity').value;
            
            if(!street || !city) {
                alert("Please enter your delivery address.");
                return;
            }

            const paymentMethod = document.getElementById('paymentMethodSelect').value;
            
            if(!paymentMethod) {
                alert("Please select a payment method.");
                return;
            }
            
            payBtn.disabled = true;
            payBtn.textContent = "Processing...";
            
            setTimeout(() => {
                alert(`Payment Successful via ${paymentMethod}!\n\nYour order for item #${id} has been placed.`);
                window.location.href = "index.html";
            }, 1500);
        });

        loadOrder();
    </script>
</body>
</html>
