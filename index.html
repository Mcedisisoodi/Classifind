<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>HoneyPot – Local Classifieds</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <script type="module" src="app.js"></script>
</head>
<body>
    <header>
        <div class="logo">Honey<span>Pot</span> <img src="public/categories/HoneyPot.png" alt="HoneyPot Logo" style="height: 30px; vertical-align: middle; margin-left: 5px;"></div>
        <div class="header-actions">
            <button class="btn" id="loginBtn">Login</button>
            <button class="btn" id="signupBtn">Sign up</button>
            <a href="post-ad.html" class="btn primary" id="postAdBtn" style="text-decoration:none;">+ Post Ad</a>
        </div>
    </header>
    <main>
        <section class="search-section">
            <div class="search-row">
                <input id="searchText" type="text" placeholder="Find cars, phones, property..." />
                <select id="provinceSelect">
                    <option value="All provinces">All provinces</option>
                    <option value="Gauteng">Gauteng</option>
                    <option value="Western Cape">Western Cape</option>
                    <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                    <option value="Eastern Cape">Eastern Cape</option>
                    <option value="Free State">Free State</option>
                    <option value="North West">North West</option>
                    <option value="Limpopo">Limpopo</option>
                    <option value="Mpumalanga">Mpumalanga</option>
                    <option value="Northern Cape">Northern Cape</option>
                </select>
                <select id="searchLocation">
                    <option value="">Select Town / City</option>
                </select>
                <button id="searchBtn">Search</button>
            </div>
        </section>
        <h2 class="section-title">Browse by category</h2>
        <section class="categories" id="categoryList">
            <div class="category-card" data-category="Cars"><img src="/categories/cars.png" alt="Cars" class="category-icon-img"><span><b>Cars</b></span></div>
            <div class="category-card" data-category="Phones"><img src="/categories/phones.png" alt="Phones" class="category-icon-img"><span><b>Phones & Tablets</b></span></div>
            <div class="category-card" data-category="Property"><img src="/categories/property.png" alt="Property" class="category-icon-img"><span><b>Property</b></span></div>
            <div class="category-card" data-category="Electronics"><img src="/categories/electronics.png" alt="Electronics" class="category-icon-img"><span><b>Electronics</b></span></div>
            <div class="category-card" data-category="Fashion & Beauty"><img src="/categories/fashion.png" alt="Fashion" class="category-icon-img"><span><b>Fashion & Beauty</b></span></div>
            <div class="category-card" data-category="Jobs"><img src="/categories/jobs.png" alt="Jobs" class="category-icon-img"><span><b>Jobs</b></span></div>
            <div class="category-card" data-category="Other"><img src="/categories/other.png" alt="Other" class="category-icon-img"><span><b>Other</b></span></div>
        </section>
        <h2 class="section-title">All ads</h2>
        <div class="filters-container">
            <div class="filters-row">
                <select id="filterCategory">
                    <option value="">Category: All</option>
                    <option value="Cars">Cars</option>
                    <option value="Phones">Phones & Tablets</option>
                    <option value="Property">Property</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Fashion & Beauty">Fashion & Beauty</option>
                    <option value="Jobs">Jobs</option>
                    <option value="Other">Other</option>
                </select>
                <select id="filterSort">
                    <option value="newest">Sort: Newest</option>
                    <option value="priceLow">Price: Low to High</option>
                    <option value="priceHigh">Price: High to Low</option>
                </select>
                <select id="filterCondition">
                    <option value="">Condition: All</option>
                    <option value="New">New</option>
                    <option value="Used">Used</option>
                    <option value="Needs Repair">Needs Repair</option>
                </select>
            </div>
            <div class="filters-row">
                <div class="price-range">
                    <span>Price:</span>
                    <input type="number" id="priceMin" placeholder="Min" min="0">
                    <span>-</span>
                    <input type="number" id="priceMax" placeholder="Max" min="0">
                </div>
                <label class="verified-toggle">
                    <input type="checkbox" id="filterVerified">
                    <span>Verified Only</span>
                </label>
            </div>
        </div>
        <section class="ads-grid" id="adsGrid"></section>
        <footer>
            <div style="max-width:1100px; margin:0 auto; text-align:left; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; padding:20px 10px;">
                <div>
                    <h4 style="font-size:0.9rem; font-weight:700; margin-bottom:6px;">Account</h4>
                    <p><a href="my-account.html">My Account</a></p>
                    <p><a href="track-order.html">Track Order</a></p>
                    <p><a href="returns.html">Returns</a></p>
                    <p><a href="personal-details.html">Personal Details</a></p>
                    <p><a href="invoices.html">Invoices</a></p>
                </div>
                <div>
                    <h4 style="font-size:0.9rem; font-weight:700; margin-bottom:6px;">Help</h4>
                    <p><a href="help-centre.html">Help Centre</a></p>
                    <p><a href="contact-us.html">Contact Us</a></p>
                    <p><a href="shipping-delivery.html">Shipping & Delivery</a></p>
                    <p><a href="returns.html">Returns</a></p>
                </div>
                <div>
                    <h4 style="font-size:0.9rem; font-weight:700; margin-bottom:6px;">Company</h4>
                    <p><a href="about-us.html">About Us</a></p>
                </div>
                <div>
                    <h4 style="font-size:0.9rem; font-weight:700; margin-bottom:6px;">HoneyPot Policy</h4>
                    <p><a href="returns-policy.html">Returns Policy</a></p>
                    <p><a href="terms-conditions.html">Terms & Conditions</a></p>
                    <p><a href="privacy-policy.html">Privacy Policy</a></p>
                </div>
            </div>
            <div style="text-align:center; margin-top:20px; font-size:0.8rem; color:#666;">&copy; <span id="year"></span> HoneyPot. Inspired by global classifieds, built for you.</div>
        </footer>
    </main>

    <!-- Login modal -->
    <div class="auth-backdrop" id="loginBackdrop">
        <div class="auth-modal">
            <div class="auth-header">
                <h2>Login</h2>
                <button class="auth-close" id="loginClose">&times;</button>
            </div>
            <div class="auth-body">
                <label for="loginEmail">Email or Phone</label>
                <input id="loginEmail" type="text" placeholder="you@example.com" />
                <label for="loginPassword">Password</label>
                <input id="loginPassword" type="password" placeholder="Enter your password" />
                <button class="auth-submit" id="loginSubmit">Login</button>
                <div class="auth-actions">
                    <span id="forgotPassword" class="auth-link" style="font-size:0.8rem;">Forgot Password?</span>
                    <span>New here? <span id="goToSignup" class="auth-link">Create an account</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign up modal -->
    <div class="auth-backdrop" id="signupBackdrop">
        <div class="auth-modal">
            <div class="auth-header">
                <h2>Sign up</h2>
                <button class="auth-close" id="signupClose">&times;</button>
            </div>
            <div class="auth-body">
                <label for="signupName">Name</label>
                <input id="signupName" type="text" placeholder="First Name" />
                <label for="signupSurname">Surname</label>
                <input id="signupSurname" type="text" placeholder="Last Name" />
                <label for="signupAddress">Address</label>
                <input id="signupAddress" type="text" placeholder="Your Address" />
                <label for="signupPhone">Phone Number</label>
                <input id="signupPhone" type="tel" placeholder="072 123 4567" />
                <label for="signupEmail">Email</label>
                <input id="signupEmail" type="email" placeholder="you@example.com" />
                
                <label>I am a:</label>
                <select id="signupRole">
                    <option value="buyer">Buyer</option>
                    <option value="seller">Seller</option>
                </select>

                <div id="bankDetailsSection" class="hidden">
                    <label for="signupBank">Bank Account Details</label>
                    <textarea id="signupBank" placeholder="Bank Name, Account Number, Branch Code" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;"></textarea>
                </div>

                <div class="field-group">
                    <label for="signupPassword">Password</label>
                    <input id="signupPassword" type="password" placeholder="Create a password" />
                </div>
                <div class="field-group">
                    <label for="signupPasswordConfirm">Confirm Password</label>
                    <input id="signupPasswordConfirm" type="password" placeholder="Re-enter password" />
                </div>

                <button class="auth-submit" id="signupSubmit">Create account</button>
                <div class="auth-actions">
                    <span>Already have an account? <span id="goToLogin" class="auth-link">Login</span></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabaseClient, signIn, signUp, resetPassword } from './app.js';

        // --- Ads Logic ---
        let ads = [];
        const adsGrid = document.getElementById("adsGrid");
        const filterCategory = document.getElementById("filterCategory");
        const filterSort = document.getElementById("filterSort");
        const filterCondition = document.getElementById("filterCondition");
        const filterVerified = document.getElementById("filterVerified");
        const priceMin = document.getElementById("priceMin");
        const priceMax = document.getElementById("priceMax");
        const searchText = document.getElementById("searchText");
        const searchLocation = document.getElementById("searchLocation");
        const provinceSelect = document.getElementById("provinceSelect");

        // Province Data
        const provinceAreas = {
            "Gauteng": ["Johannesburg","Soweto","Pretoria","Centurion","Sandton","Midrand","Randburg","Roodepoort","Krugersdorp","Alberton","Benoni","Boksburg","Brakpan","Springs","Germiston","Kempton Park","Tembisa","Katlehong","Vosloorus","Mamelodi","Soshanguve","Ga-Rankuwa","Vanderbijlpark","Vereeniging","Heidelberg","Nigel","Cullinan","Bronkhorstspruit","Carletonville","Westonaria","Randfontein","Lenasia","Diepsloot","Tsakane","Daveyton","Edenvale","Bedfordview"],
            "Western Cape": ["Cape Town","Bellville","Brackenfell","Durbanville","Goodwood","Parow","Kraaifontein","Kuils River","Mitchells Plain","Khayelitsha","Fish Hoek","Muizenberg","Somerset West","Strand","Gordons Bay","Stellenbosch","Paarl","Wellington","Franschhoek","Worcester","Ceres","Robertson","George","Mossel Bay","Oudtshoorn","Knysna","Plettenberg Bay","Beaufort West","Vredenburg","Saldanha","Malmesbury","Langebaan"],
            "KwaZulu-Natal": ["Durban","Umlazi","Chatsworth","Phoenix","Pinetown","Westville","Hillcrest","Kloof","Queensburgh","Umbilo","Isipingo","Umkomaas","Amanzimtoti","Umhlanga","Ballito","Stanger","Richards Bay","Empangeni","Eshowe","Mtunzini","Port Shepstone","Margate","Ramsgate","Harding","Pietermaritzburg","Howick","Mooi River","Greytown","Newcastle","Ladysmith","Estcourt","Vryheid","Dundee","Bergville"],
            "Eastern Cape": ["Gqeberha","Uitenhage","Despatch","East London","Mdantsane","King William's Town","Qonce","Bhisho","Butterworth","Mthatha","Queenstown","Aliwal North","Makhanda","Graaff-Reinet","Cradock","Port Alfred","Jeffreys Bay","Humansdorp","Kirkwood","Fort Beaufort","Alice","Stutterheim","Mount Frere","Matatiele","Lusikisiki","Port St Johns"],
            "Free State": ["Bloemfontein","Botshabelo","Thaba Nchu","Welkom","Virginia","Hennenman","Odendaalsrus","Kroonstad","Sasolburg","Parys","Vredefort","Phuthaditjhaba","Bethlehem","Reitz","Harrismith","Clocolan","Ladybrand","Ficksburg","Fouriesburg","Warden","Heilbron","Viljoenskroon","Frankfort","Deneysville"],
            "North West": ["Mahikeng","Mmabatho","Rustenburg","Klerksdorp","Jouberton","Orkney","Stilfontein","Potchefstroom","Ikageng","Vryburg","Lichtenburg","Zeerust","Schweizer-Reneke","Bloemhof","Christiana","Brits","Hartebeespoort","Mogwase","Sun City","Ventersdorp","Coligny","Swartruggens"],
            "Limpopo": ["Polokwane","Seshego","Lebowakgomo","Mankweng","Thohoyandou","Sibasa","Louis Trichardt","Makhado","Musina","Tzaneen","Letsitele","Phalaborwa","Giyani","Malamulele","Burgersfort","Mokopane","Mahwelereng","Modimolle","Bela-Bela","Lephalale","Thabazimbi","Dendron","Botlokwa"],
            "Mpumalanga": ["Mbombela","Nelspruit","White River","Hazyview","Sabie","Graskop","Lydenburg","Mashishing","Barberton","Malelane","Komatipoort","Ermelo","Secunda","Trichardt","Bethal","Standerton","Middelburg","eMalahleni","Witbank","Ogies","Delmas","Volksrust","Carolina","Mkhondo","Piet Retief"],
            "Northern Cape": ["Kimberley","Barkly West","Warrenton","Jan Kempdorp","Hartswater","Upington","Keimoes","Kakamas","Groblershoop","Prieska","De Aar","Britstown","Victoria West","Strydenburg","Colesberg","Springbok","Okiep","Concordia","Pofadder","Port Nolloth","Alexander Bay","Kuruman","Kathu","Postmasburg","Danielskuil"]
        };

        function populateTownsForProvince(province) {
            searchLocation.innerHTML = "";
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "Select Town / City";
            searchLocation.appendChild(defaultOption);
            if (province === "All provinces") return;
            const towns = provinceAreas[province] || [];
            towns.forEach(town => {
                const option = document.createElement("option");
                option.value = town;
                option.textContent = town;
                searchLocation.appendChild(option);
            });
        }

        provinceSelect.addEventListener("change", () => {
            populateTownsForProvince(provinceSelect.value);
            applyFilters();
        });

        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='24' fill='%23666666'%3ENo Image%3C/text%3E%3C/svg%3E";

        function renderAds(list) {
            adsGrid.innerHTML = "";
            if (!list.length) {
                adsGrid.innerHTML = "<p>No ads found. Try changing your filters.</p>";
                return;
            }
            list.forEach(ad => {
                const card = document.createElement("article");
                card.className = "ad-card";
                card.dataset.id = ad.id;
                
                const imgDiv = document.createElement("div");
                imgDiv.className = "ad-image";
                // Use img tag for better object-fit control
                const img = document.createElement("img");
                img.src = ad.img || PLACEHOLDER_IMG;
                img.loading = "lazy";
                imgDiv.appendChild(img);

                const body = document.createElement("div");
                body.className = "ad-body";
                const price = document.createElement("div");
                price.className = "ad-price";
                price.textContent = ad.price > 0 ? "R " + Number(ad.price).toLocaleString() : "Price on request";
                const title = document.createElement("div");
                title.className = "ad-title";
                title.textContent = ad.title;
                const location = document.createElement("div");
                location.className = "ad-location";
                location.textContent = ad.location + " • " + ad.category;
                const meta = document.createElement("div");
                meta.className = "ad-meta";
                meta.textContent = "Posted: " + ad.postedAt;
                body.appendChild(price);
                body.appendChild(title);
                body.appendChild(location);
                body.appendChild(meta);
                card.appendChild(imgDiv);
                card.appendChild(body);
                
                // Link to Ad Details Page
                card.addEventListener("click", () => {
                    window.location.href = `ad-details.html?id=${ad.id}`;
                });
                
                adsGrid.appendChild(card);
            });
        }

        async function fetchAdsFromSupabase() {
            const { data, error } = await supabaseClient
                .from("ads")
                .select("*")
                .order("created_at", { ascending: false });
            if (error) {
                console.error("Error fetching ads from Supabase:", error);
                return;
            }
            ads = (data || []).map(row => {
                // Determine primary image: use first from 'images' array if available, else fallback to 'image_url'
                let primaryImg = "";
                if (row.images && Array.isArray(row.images) && row.images.length > 0) {
                    // Find first valid image URL
                    const validImg = row.images.find(url => url && (url.match(/^https?:\/\//i) || url.match(/^data:image\//i) || url.startsWith('/')));
                    primaryImg = validImg || row.images[0];
                } else {
                    primaryImg = row.image_url || "";
                }

                // Final validation check
                if (primaryImg && !primaryImg.match(/^https?:\/\//i) && !primaryImg.match(/^data:image\//i) && !primaryImg.startsWith('/')) {
                    primaryImg = ""; // Invalid URL (e.g. email address)
                }

                return {
                    id: row.id,
                    title: row.title,
                    price: row.price || 0,
                    category: row.category,
                    condition: row.condition || "Used",
                    verified: row.verified || false,
                    location: row.location,
                    img: primaryImg,
                    description: row.description,
                    seller: row.seller_name || (row.contact ? row.contact : "Private seller"),
                    postedAt: row.created_at ? row.created_at.slice(0, 10) : ""
                };
            });
            applyFilters();
        }

        function applyFilters() {
            let list = [...ads];
            
            // Text Search
            const text = searchText.value.trim().toLowerCase();
            if (text) {
                list = list.filter(ad =>
                    ad.title.toLowerCase().includes(text) ||
                    ad.description.toLowerCase().includes(text)
                );
            }

            // Location Filter (Case Insensitive Fix)
            const province = provinceSelect.value;
            const loc = searchLocation.value.toLowerCase();
            
            if (province && province !== "All provinces") {
                list = list.filter(ad => {
                    const adLoc = ad.location.toLowerCase();
                    const towns = (provinceAreas[province] || []).map(t => t.toLowerCase());
                    return towns.includes(adLoc) || adLoc.includes(province.toLowerCase());
                });
            }
            
            if (loc) {
                list = list.filter(ad => ad.location.toLowerCase() === loc);
            }

            // Category Filter
            const cat = filterCategory.value;
            if (cat) {
                list = list.filter(ad => ad.category === cat);
            }

            // Condition Filter
            const cond = filterCondition.value;
            if (cond) {
                list = list.filter(ad => ad.condition === cond);
            }

            // Verified Filter
            if (filterVerified.checked) {
                list = list.filter(ad => ad.verified === true);
            }

            // Price Range Filter
            const min = priceMin.value ? Number(priceMin.value) : 0;
            const max = priceMax.value ? Number(priceMax.value) : Infinity;
            
            list = list.filter(ad => {
                const p = ad.price || 0;
                return p >= min && p <= max;
            });

            // Sorting
            const sort = filterSort.value;
            if (sort === "priceLow") {
                list.sort((a, b) => (a.price || 0) - (b.price || 0));
            } else if (sort === "priceHigh") {
                list.sort((a, b) => (b.price || 0) - (a.price || 0));
            } else if (sort === "newest") {
                list.sort((a, b) => new Date(b.postedAt) - new Date(a.postedAt));
            }
            renderAds(list);
        }

        document.getElementById("searchBtn").addEventListener("click", applyFilters);
        filterCategory.addEventListener("change", applyFilters);
        filterSort.addEventListener("change", applyFilters);
        filterCondition.addEventListener("change", applyFilters);
        filterVerified.addEventListener("change", applyFilters);
        priceMin.addEventListener("input", applyFilters);
        priceMax.addEventListener("input", applyFilters);
        searchLocation.addEventListener("change", applyFilters);
        searchText.addEventListener("keyup", (e) => {
            if (e.key === "Enter") applyFilters();
        });
        document.getElementById("categoryList").addEventListener("click", (e) => {
            const card = e.target.closest(".category-card");
            if (!card) return;
            const cat = card.dataset.category;
            filterCategory.value = cat;
            applyFilters();
            const filtersEl = document.querySelector(".filters");
            if (filtersEl) {
                window.scrollTo({ top: filtersEl.offsetTop - 60, behavior: "smooth" });
            }
        });

        // --- Auth Modals Logic ---
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const loginBackdrop = document.getElementById("loginBackdrop");
        const signupBackdrop = document.getElementById("signupBackdrop");
        const loginClose = document.getElementById("loginClose");
        const signupClose = document.getElementById("signupClose");
        const goToSignup = document.getElementById("goToSignup");
        const goToLogin = document.getElementById("goToLogin");
        const forgotPassword = document.getElementById("forgotPassword");
        const signupRole = document.getElementById("signupRole");
        const bankDetailsSection = document.getElementById("bankDetailsSection");

        if(loginBtn) loginBtn.addEventListener("click", () => loginBackdrop.style.display = "flex");
                if(signupBtn) signupBtn.addEventListener("click", () => {
            signupBackdrop.style.display = "flex";
            // Reset form state
            if(signupRole) signupRole.value = "buyer";
            if(bankDetailsSection) bankDetailsSection.classList.add("hidden");
        });
        if(loginClose) loginClose.addEventListener("click", () => loginBackdrop.style.display = "none");
        if(signupClose) signupClose.addEventListener("click", () => signupBackdrop.style.display = "none");
        
        if(goToSignup) goToSignup.addEventListener("click", () => {
            loginBackdrop.style.display = "none";
            signupBackdrop.style.display = "flex";
            // Reset form state
            if(signupRole) signupRole.value = "buyer";
            if(bankDetailsSection) bankDetailsSection.classList.add("hidden");
        });
        if(goToLogin) goToLogin.addEventListener("click", () => {
            signupBackdrop.style.display = "none";
            loginBackdrop.style.display = "flex";
        });

        if(signupRole) {
            signupRole.addEventListener("change", () => {
                if(signupRole.value === "seller") {
                    bankDetailsSection.classList.remove("hidden");
                } else {
                    bankDetailsSection.classList.add("hidden");
                }
            });
        }

        if(forgotPassword) {
            forgotPassword.addEventListener("click", async () => {
                const email = prompt("Please enter your email address to reset your password:");
                if(email) {
                    const { error } = await resetPassword(email);
                    if(error) alert("Error: " + error.message);
                    else alert("Password reset link sent to " + email);
                }
            });
        }

        // Auth Submit
        document.getElementById("loginSubmit").addEventListener("click", async () => {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            const { error } = await signIn(email, password);
            if (error) alert("Login failed: " + error.message);
            else {
                loginBackdrop.style.display = "none";
            }
        });

        document.getElementById("signupSubmit").addEventListener("click", async () => {
            const email = document.getElementById("signupEmail").value;
            const password = document.getElementById("signupPassword").value;
            const confirm = document.getElementById("signupPasswordConfirm").value;
            
            if(password !== confirm) {
                alert("Passwords do not match!");
                return;
            }

            const metadata = {
                first_name: document.getElementById("signupName").value,
                last_name: document.getElementById("signupSurname").value,
                address: document.getElementById("signupAddress").value,
                phone: document.getElementById("signupPhone").value,
                role: document.getElementById("signupRole").value,
                bank_details: document.getElementById("signupBank").value
            };

            const { error } = await signUp(email, password, metadata);
            if (error) alert("Signup failed: " + error.message);
            else {
                alert("Account created! Please check your email to verify.");
                signupBackdrop.style.display = "none";
            }
        });

        document.getElementById("year").textContent = new Date().getFullYear();
        populateTownsForProvince("All provinces");
        fetchAdsFromSupabase();
    </script>
</body>
</html>
