<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Ad Details – HoneySweetpot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <script type="module" src="app.js"></script>
</head>
<body>
    <header>
        <div class="logo"><a href="index.html" style="text-decoration:none; color:inherit;">Honey<span>Sweetpot</span> <img src="categories/HoneyPot.webp" alt="HoneySweetpot Logo" style="height: 60px; vertical-align: bottom; margin-left: 5px;"></a></div>
        <div class="header-actions">
            <button class="btn" id="loginBtn">Login</button>
            <button class="btn" id="signupBtn">Sign up</button>
            <a href="post-ad.html" class="btn primary" id="postAdBtn" style="text-decoration:none;">+ Post Ad</a>
        </div>
    </header>
    <main>
        <div class="ad-details-container" id="adDetails">
            <p style="text-align:center; padding: 40px;">Loading ad details...</p>
        </div>
    </main>

    <!-- Auth Modals (Included for consistency) -->
    <div class="auth-backdrop" id="loginBackdrop">
        <div class="auth-modal">
            <div class="auth-header">
                <h2>Login</h2>
                <button class="auth-close" id="loginClose">&times;</button>
            </div>
            <div class="auth-body">
                <label for="loginEmail">Email or Phone</label>
                <input id="loginEmail" type="text" placeholder="you@example.com" />
                <label for="loginPassword">Password</label>
                <input id="loginPassword" type="password" placeholder="Enter your password" />
                <button class="auth-submit" id="loginSubmit">Login</button>
                <div class="auth-actions">
                    <span id="forgotPassword" class="auth-link" style="font-size:0.8rem;">Forgot Password?</span>
                    <span>New here? <span id="goToSignup" class="auth-link">Create an account</span></span>
                </div>
            </div>
        </div>
    </div>

    <div class="auth-backdrop" id="signupBackdrop">
        <div class="auth-modal">
            <div class="auth-header">
                <h2>Sign up</h2>
                <button class="auth-close" id="signupClose">&times;</button>
            </div>
            <div class="auth-body">
                <label for="signupName">Name</label>
                <input id="signupName" type="text" placeholder="First Name" />
                <label for="signupSurname">Surname</label>
                <input id="signupSurname" type="text" placeholder="Last Name" />
                <label for="signupAddress">Address</label>
                <input id="signupAddress" type="text" placeholder="Your Address" />
                <label for="signupPhone">Phone Number</label>
                <input id="signupPhone" type="tel" placeholder="072 123 4567" />
                <label for="signupEmail">Email</label>
                <input id="signupEmail" type="email" placeholder="you@example.com" />
                
                <label>I am a:</label>
                <select id="signupRole">
                    <option value="buyer">Buyer</option>
                    <option value="seller">Seller</option>
                </select>

                <div id="bankDetailsSection" class="hidden">
                    <label for="signupBank">Bank Account Details</label>
                    <textarea id="signupBank" placeholder="Bank Name, Account Number, Branch Code" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;"></textarea>
                </div>

                <div class="field-group">
                    <label for="signupPassword">Password</label>
                    <input id="signupPassword" type="password" placeholder="Create a password" />
                </div>
                <div class="field-group">
                    <label for="signupPasswordConfirm">Confirm Password</label>
                    <input id="signupPasswordConfirm" type="password" placeholder="Re-enter password" />
                </div>

                <button class="auth-submit" id="signupSubmit">Create account</button>
                <div class="auth-actions">
                    <span>Already have an account? <span id="goToLogin" class="auth-link">Login</span></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabaseClient, signIn, signUp, resetPassword, getSession } from './app.js';

        // --- Post Ad Button Logic ---
        const postAdBtn = document.getElementById("postAdBtn");
        if (postAdBtn) {
            postAdBtn.addEventListener("click", async (e) => {
                e.preventDefault();
                const session = await getSession();
                if (session) {
                    window.location.href = "post-ad.html";
                } else {
                    const loginBackdrop = document.getElementById("loginBackdrop");
                    if (loginBackdrop) loginBackdrop.style.display = "flex";
                }
            });
        }

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const container = document.getElementById('adDetails');
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='24' fill='%23666666'%3ENo Image%3C/text%3E%3C/svg%3E";

        async function loadAd() {
            if (!id) {
                container.innerHTML = "<p>Ad not found.</p>";
                return;
            }

            const { data: ad, error } = await supabaseClient
                .from('ads')
                .select('*')
                .eq('id', id)
                .single();

            if (error || !ad) {
                container.innerHTML = "<p>Ad not found or error loading details.</p>";
                console.error(error);
                return;
            }

            // Check if hidden or sold
            if (ad.sold) {
                 container.innerHTML = "<div style='text-align:center; padding:40px;'><h2>This item has been sold.</h2><p>This ad is no longer available.</p><a href='index.html' class='btn'>Back to Home</a></div>";
                 return;
            }

            if (ad.hidden) {
                // Allow admin to view, but warn
                const session = await getSession();
                const isAdmin = session && session.user && session.user.email.toLowerCase() === "compsody@gmail.com";
                
                if (!isAdmin) {
                    container.innerHTML = "<p>This ad is no longer available.</p>";
                    return;
                } else {
                    container.innerHTML += '<div style="background:red; color:white; padding:10px; text-align:center; margin-bottom:10px;">HIDDEN AD (Admin View)</div>';
                }
            }

            const imgUrl = ad.image_url || PLACEHOLDER_IMG;
            
            // Prepare images array
            let images = [];
            if (ad.images && Array.isArray(ad.images) && ad.images.length > 0) {
                images = ad.images;
            } else if (ad.image_url) {
                images = [ad.image_url];
            } else {
                images = [PLACEHOLDER_IMG];
            }

            // Filter out invalid images (e.g. email addresses or non-URLs)
            images = images.filter(url => {
                if (!url) return false;
                return url.match(/^https?:\/\//i) || url.match(/^data:image\//i) || url.startsWith('/');
            });

            if (images.length === 0) {
                images = [PLACEHOLDER_IMG];
            }

            const price = ad.price > 0 ? "R " + Number(ad.price).toLocaleString() : "Price on request";
            
            let displayDate = "Unknown date";
            if (ad.created_at) {
                const date = new Date(ad.created_at);
                const now = new Date();
                const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const n = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const y = new Date(n);
                y.setDate(n.getDate() - 1);

                if (d.getTime() === n.getTime()) displayDate = "Today";
                else if (d.getTime() === y.getTime()) displayDate = "Yesterday";
                else displayDate = ad.created_at.slice(0, 10);
            }

            container.innerHTML = `
                <div class="ad-slideshow-container">
                    <div class="ad-slideshow-viewport" id="mainSlideWrapper">
                        <img class="ad-slideshow-image" id="mainSlide" src="${images[0]}" alt="Ad Image" draggable="false" />
                        
                        <!-- Controls Overlay -->
                        <div class="slideshow-controls">
                            ${images.length > 1 ? `
                                <button class="slideshow-arrow prev" id="prevSlide">&#10094;</button>
                                <button class="slideshow-arrow next" id="nextSlide">&#10095;</button>
                            ` : ''}
                            
                            <div class="zoom-controls">
                                <button class="zoom-btn" id="zoomIn" title="Zoom In">+</button>
                                <button class="zoom-btn" id="zoomOut" title="Zoom Out">-</button>
                            </div>
                        </div>
                        
                        <div class="slide-hint">Click arrows to navigate • Use +/- to zoom</div>
                    </div>

                    ${images.length > 1 ? `
                    <div class="ad-thumbnails" id="thumbnailContainer">
                        ${images.map((img, idx) => `
                            <div class="ad-thumb ${idx === 0 ? 'active' : ''}" data-index="${idx}" style="background-image: url('${img}')"></div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>

                <div class="ad-details-info">
                    <h1>${ad.title}</h1>
                    <div class="ad-details-price">${price}</div>
                    <p style="color:#555; margin-bottom:20px;">${ad.location} • ${ad.category} • <span style="color: #00008B; font-weight: 600;">Posted:</span> <span style="color: #00008B; font-weight: 600;">${displayDate}</span></p>
                    
                    <h3 style="margin-bottom:10px;">Description</h3>
                    <p style="line-height:1.6; margin-bottom:20px;">${ad.description}</p>
                    
                    <h3 style="margin-bottom:10px;">Seller Info</h3>
                    <p><strong>${ad.seller_name || "Private Seller"}</strong></p>
                    <p>${ad.contact || "No contact info"}</p>

                    <div class="buy-buttons">
                        <button class="btn secured" id="securedBuyBtn">Secured buy</button>
                        <button class="btn unsecured" onclick="alert('Unsecured Buy initiated!')">Unsecured buy</button>
                    </div>
                </div>
            `;

            // Add event listener for Secured Buy button
            const securedBuyBtn = document.getElementById('securedBuyBtn');
            if (securedBuyBtn) {
                securedBuyBtn.addEventListener('click', () => {
                    window.location.href = `checkout.html?id=${ad.id}`;
                });
            }

            // Slideshow Logic
            let currentIndex = 0;
            let currentZoom = 1;
            let translateX = 0;
            let translateY = 0;
            let isDragging = false;
            let startX, startY, initialTranslateX, initialTranslateY;

            const mainSlide = document.getElementById("mainSlide");
            const thumbs = document.querySelectorAll(".ad-thumb");
            const prevBtn = document.getElementById("prevSlide");
            const nextBtn = document.getElementById("nextSlide");
            const zoomInBtn = document.getElementById("zoomIn");
            const zoomOutBtn = document.getElementById("zoomOut");

            function updateTransform() {
                mainSlide.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
                
                if (currentZoom > 1) {
                    mainSlide.style.cursor = isDragging ? "grabbing" : "grab";
                } else {
                    mainSlide.style.cursor = "default";
                }
            }

            function showSlide(index) {
                currentIndex = index;
                if (currentIndex >= images.length) currentIndex = 0;
                if (currentIndex < 0) currentIndex = images.length - 1;

                // Reset zoom and position when changing slide
                currentZoom = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();

                mainSlide.src = images[currentIndex];
                
                // Update thumbs
                if (thumbs.length > 0) {
                    thumbs.forEach(t => t.classList.remove("active"));
                    if (thumbs[currentIndex]) thumbs[currentIndex].classList.add("active");
                }
            }

            // Zoom Buttons
            if (zoomInBtn) {
                zoomInBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    if (currentZoom < 3) {
                        currentZoom += 0.5;
                        updateTransform();
                    }
                });
            }

            if (zoomOutBtn) {
                zoomOutBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    if (currentZoom > 1) {
                        currentZoom -= 0.5;
                        // If zooming out to 1, reset position
                        if (currentZoom === 1) {
                            translateX = 0;
                            translateY = 0;
                        }
                        updateTransform();
                    }
                });
            }

            // Double Click to Zoom
            mainSlide.addEventListener("dblclick", (e) => {
                e.preventDefault();
                if (currentZoom === 1) {
                    currentZoom = 2; // Zoom in
                } else {
                    currentZoom = 1; // Reset
                    translateX = 0;
                    translateY = 0;
                }
                updateTransform();
            });

            // Drag / Pan Logic
            mainSlide.addEventListener("mousedown", (e) => {
                if (currentZoom > 1) {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialTranslateX = translateX;
                    initialTranslateY = translateY;
                    mainSlide.style.cursor = "grabbing";
                    e.preventDefault(); // Prevent default drag behavior
                }
            });

            window.addEventListener("mousemove", (e) => {
                if (isDragging && currentZoom > 1) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    translateX = initialTranslateX + dx;
                    translateY = initialTranslateY + dy;
                    updateTransform();
                }
            });

            window.addEventListener("mouseup", () => {
                if (isDragging) {
                    isDragging = false;
                    updateTransform(); // Reset cursor
                }
            });

            // Touch Events for Mobile Dragging & Pinch Zoom
            let initialPinchDist = 0;
            let initialZoom = 1;

            mainSlide.addEventListener("touchstart", (e) => {
                if (e.touches.length === 1 && currentZoom > 1) {
                    // Dragging
                    isDragging = true;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    initialTranslateX = translateX;
                    initialTranslateY = translateY;
                } else if (e.touches.length === 2) {
                    // Pinch Zoom Start
                    isDragging = false; // Cancel drag if pinching
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    initialPinchDist = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    initialZoom = currentZoom;
                    e.preventDefault(); // Prevent default pinch behavior
                }
            }, { passive: false });

            window.addEventListener("touchmove", (e) => {
                if (e.touches.length === 1 && isDragging && currentZoom > 1) {
                    // Dragging
                    const dx = e.touches[0].clientX - startX;
                    const dy = e.touches[0].clientY - startY;
                    translateX = initialTranslateX + dx;
                    translateY = initialTranslateY + dy;
                    updateTransform();
                    e.preventDefault(); 
                } else if (e.touches.length === 2) {
                    // Pinch Zooming
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDist = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    
                    if (initialPinchDist > 0) {
                        const scale = currentDist / initialPinchDist;
                        let newZoom = initialZoom * scale;
                        
                        // Clamp zoom
                        if (newZoom < 1) newZoom = 1;
                        if (newZoom > 4) newZoom = 4;
                        
                        currentZoom = newZoom;
                        
                        // If zooming out to 1, reset position
                        if (currentZoom === 1) {
                            translateX = 0;
                            translateY = 0;
                        }
                        
                        updateTransform();
                        e.preventDefault();
                    }
                }
            }, { passive: false });

            window.addEventListener("touchend", () => {
                isDragging = false;
            });

            // Navigation Arrows
            if (prevBtn) {
                prevBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    showSlide(currentIndex - 1);
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    showSlide(currentIndex + 1);
                });
            }

            if (thumbs.length > 0) {
                thumbs.forEach(thumb => {
                    thumb.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const idx = parseInt(thumb.dataset.index);
                        showSlide(idx);
                    });
                });
            }
        }

        loadAd();

        // --- Auth Logic (Shared) ---
        // Ideally this should be in app.js or a shared script, but for now duplicating the event listeners
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const loginBackdrop = document.getElementById("loginBackdrop");
        const signupBackdrop = document.getElementById("signupBackdrop");
        const loginClose = document.getElementById("loginClose");
        const signupClose = document.getElementById("signupClose");
        const goToSignup = document.getElementById("goToSignup");
        const goToLogin = document.getElementById("goToLogin");
        const forgotPassword = document.getElementById("forgotPassword");
        const signupRole = document.getElementById("signupRole");
        const bankDetailsSection = document.getElementById("bankDetailsSection");

        if(loginBtn) loginBtn.addEventListener("click", () => loginBackdrop.style.display = "flex");
                if(signupBtn) signupBtn.addEventListener("click", () => {
            signupBackdrop.style.display = "flex";
            // Reset form state
            if(signupRole) signupRole.value = "buyer";
            if(bankDetailsSection) bankDetailsSection.classList.add("hidden");
        });
        if(loginClose) loginClose.addEventListener("click", () => loginBackdrop.style.display = "none");
        if(signupClose) signupClose.addEventListener("click", () => signupBackdrop.style.display = "none");
        
        if(goToSignup) goToSignup.addEventListener("click", () => {
            loginBackdrop.style.display = "none";
            signupBackdrop.style.display = "flex";
            // Reset form state
            if(signupRole) signupRole.value = "buyer";
            if(bankDetailsSection) bankDetailsSection.classList.add("hidden");
        });
        if(goToLogin) goToLogin.addEventListener("click", () => {
            signupBackdrop.style.display = "none";
            loginBackdrop.style.display = "flex";
        });

        if(signupRole) {
            signupRole.addEventListener("change", () => {
                if(signupRole.value === "seller") {
                    bankDetailsSection.classList.remove("hidden");
                } else {
                    bankDetailsSection.classList.add("hidden");
                }
            });
        }

        if(forgotPassword) {
            forgotPassword.addEventListener("click", async () => {
                const email = prompt("Please enter your email address to reset your password:");
                if(email) {
                    const { error } = await resetPassword(email);
                    if(error) alert("Error: " + error.message);
                    else alert("Password reset link sent to " + email);
                }
            });
        }

        document.getElementById("loginSubmit").addEventListener("click", async () => {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            const { error } = await signIn(email, password);
            if (error) alert("Login failed: " + error.message);
            else loginBackdrop.style.display = "none";
        });

        document.getElementById("signupSubmit").addEventListener("click", async () => {
            const email = document.getElementById("signupEmail").value;
            const password = document.getElementById("signupPassword").value;
            const confirm = document.getElementById("signupPasswordConfirm").value;
            
            if(password !== confirm) {
                alert("Passwords do not match!");
                return;
            }

            const metadata = {
                first_name: document.getElementById("signupName").value,
                last_name: document.getElementById("signupSurname").value,
                address: document.getElementById("signupAddress").value,
                phone: document.getElementById("signupPhone").value,
                role: document.getElementById("signupRole").value,
                bank_details: document.getElementById("signupBank").value
            };

            const { error } = await signUp(email, password, metadata);
            if (error) alert("Signup failed: " + error.message);
            else {
                alert("Account created! Please check your email to verify.");
                signupBackdrop.style.display = "none";
            }
        });
    </script>
</body>
</html>
