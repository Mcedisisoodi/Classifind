<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Ad Details – ClassiFind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <script type="module" src="app.js"></script>
</head>
<body>
    <header>
        <div class="logo"><a href="index.html" style="text-decoration:none; color:inherit;">Classi<span>Find</span></a></div>
        <div class="header-actions">
            <button class="btn" id="loginBtn">Login</button>
            <button class="btn" id="signupBtn">Sign up</button>
            <a href="post-ad.html" class="btn primary" id="postAdBtn" style="text-decoration:none;">+ Post Ad</a>
        </div>
    </header>
    <main>
        <div class="ad-details-container" id="adDetails">
            <p style="text-align:center; padding: 40px;">Loading ad details...</p>
        </div>
    </main>

    <!-- Auth Modals (Included for consistency) -->
    <div class="auth-backdrop" id="loginBackdrop">
        <div class="auth-modal">
            <div class="auth-header">
                <h2>Login</h2>
                <button class="auth-close" id="loginClose">&times;</button>
            </div>
            <div class="auth-body">
                <label for="loginEmail">Email or Phone</label>
                <input id="loginEmail" type="text" placeholder="you@example.com" />
                <label for="loginPassword">Password</label>
                <input id="loginPassword" type="password" placeholder="Enter your password" />
                <button class="auth-submit" id="loginSubmit">Login</button>
                <div class="auth-actions">
                    <span id="forgotPassword" class="auth-link" style="font-size:0.8rem;">Forgot Password?</span>
                    <span>New here? <span id="goToSignup" class="auth-link">Create an account</span></span>
                </div>
            </div>
        </div>
    </div>

    <div class="auth-backdrop" id="signupBackdrop">
        <div class="auth-modal">
            <div class="auth-header">
                <h2>Sign up</h2>
                <button class="auth-close" id="signupClose">&times;</button>
            </div>
            <div class="auth-body">
                <label for="signupName">Name</label>
                <input id="signupName" type="text" placeholder="First Name" />
                <label for="signupSurname">Surname</label>
                <input id="signupSurname" type="text" placeholder="Last Name" />
                <label for="signupAddress">Address</label>
                <input id="signupAddress" type="text" placeholder="Your Address" />
                <label for="signupPhone">Phone Number</label>
                <input id="signupPhone" type="tel" placeholder="072 123 4567" />
                <label for="signupEmail">Email</label>
                <input id="signupEmail" type="email" placeholder="you@example.com" />
                
                <label>I am a:</label>
                <select id="signupRole">
                    <option value="buyer">Buyer</option>
                    <option value="seller">Seller</option>
                </select>

                <div id="bankDetailsSection" class="hidden">
                    <label for="signupBank">Bank Account Details</label>
                    <textarea id="signupBank" placeholder="Bank Name, Account Number, Branch Code" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;"></textarea>
                </div>

                <div class="field-group">
                    <label for="signupPassword">Password</label>
                    <input id="signupPassword" type="password" placeholder="Create a password" />
                </div>
                <div class="field-group">
                    <label for="signupPasswordConfirm">Confirm Password</label>
                    <input id="signupPasswordConfirm" type="password" placeholder="Re-enter password" />
                </div>

                <button class="auth-submit" id="signupSubmit">Create account</button>
                <div class="auth-actions">
                    <span>Already have an account? <span id="goToLogin" class="auth-link">Login</span></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabaseClient, signIn, signUp, resetPassword } from './app.js';

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const container = document.getElementById('adDetails');
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='24' fill='%23666666'%3ENo Image%3C/text%3E%3C/svg%3E";

        async function loadAd() {
            if (!id) {
                container.innerHTML = "<p>Ad not found.</p>";
                return;
            }

            const { data: ad, error } = await supabaseClient
                .from('ads')
                .select('*')
                .eq('id', id)
                .single();

            if (error || !ad) {
                container.innerHTML = "<p>Ad not found or error loading details.</p>";
                console.error(error);
                return;
            }

            const imgUrl = ad.image_url || PLACEHOLDER_IMG;
            const price = ad.price > 0 ? "R " + Number(ad.price).toLocaleString() : "Price on request";
            const postedDate = ad.created_at ? new Date(ad.created_at).toLocaleDateString() : "Unknown date";

            container.innerHTML = `
                <div class="ad-details-img" style="background-image: url('${imgUrl}')"></div>
                <div class="ad-details-info">
                    <h1>${ad.title}</h1>
                    <div class="ad-details-price">${price}</div>
                    <p style="color:#555; margin-bottom:20px;">${ad.location} • ${ad.category} • Posted on ${postedDate}</p>
                    
                    <h3 style="margin-bottom:10px;">Description</h3>
                    <p style="line-height:1.6; margin-bottom:20px;">${ad.description}</p>
                    
                    <h3 style="margin-bottom:10px;">Seller Info</h3>
                    <p><strong>${ad.seller_name || "Private Seller"}</strong></p>
                    <p>${ad.contact || "No contact info"}</p>

                    <div class="buy-buttons">
                        <button class="btn secured" onclick="alert('Secured Buy initiated!')">Secured buy</button>
                        <button class="btn unsecured" onclick="alert('Unsecured Buy initiated!')">Unsecured buy</button>
                    </div>
                </div>
            `;
        }

        loadAd();

        // --- Auth Logic (Shared) ---
        // Ideally this should be in app.js or a shared script, but for now duplicating the event listeners
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const loginBackdrop = document.getElementById("loginBackdrop");
        const signupBackdrop = document.getElementById("signupBackdrop");
        const loginClose = document.getElementById("loginClose");
        const signupClose = document.getElementById("signupClose");
        const goToSignup = document.getElementById("goToSignup");
        const goToLogin = document.getElementById("goToLogin");
        const forgotPassword = document.getElementById("forgotPassword");
        const signupRole = document.getElementById("signupRole");
        const bankDetailsSection = document.getElementById("bankDetailsSection");

        if(loginBtn) loginBtn.addEventListener("click", () => loginBackdrop.style.display = "flex");
        if(signupBtn) signupBtn.addEventListener("click", () => signupBackdrop.style.display = "flex");
        if(loginClose) loginClose.addEventListener("click", () => loginBackdrop.style.display = "none");
        if(signupClose) signupClose.addEventListener("click", () => signupBackdrop.style.display = "none");
        
        if(goToSignup) goToSignup.addEventListener("click", () => {
            loginBackdrop.style.display = "none";
            signupBackdrop.style.display = "flex";
        });
        if(goToLogin) goToLogin.addEventListener("click", () => {
            signupBackdrop.style.display = "none";
            loginBackdrop.style.display = "flex";
        });

        if(signupRole) {
            signupRole.addEventListener("change", () => {
                if(signupRole.value === "seller") {
                    bankDetailsSection.classList.remove("hidden");
                } else {
                    bankDetailsSection.classList.add("hidden");
                }
            });
        }

        if(forgotPassword) {
            forgotPassword.addEventListener("click", async () => {
                const email = prompt("Please enter your email address to reset your password:");
                if(email) {
                    const { error } = await resetPassword(email);
                    if(error) alert("Error: " + error.message);
                    else alert("Password reset link sent to " + email);
                }
            });
        }

        document.getElementById("loginSubmit").addEventListener("click", async () => {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            const { error } = await signIn(email, password);
            if (error) alert("Login failed: " + error.message);
            else loginBackdrop.style.display = "none";
        });

        document.getElementById("signupSubmit").addEventListener("click", async () => {
            const email = document.getElementById("signupEmail").value;
            const password = document.getElementById("signupPassword").value;
            const confirm = document.getElementById("signupPasswordConfirm").value;
            
            if(password !== confirm) {
                alert("Passwords do not match!");
                return;
            }

            const metadata = {
                first_name: document.getElementById("signupName").value,
                last_name: document.getElementById("signupSurname").value,
                address: document.getElementById("signupAddress").value,
                phone: document.getElementById("signupPhone").value,
                role: document.getElementById("signupRole").value,
                bank_details: document.getElementById("signupBank").value
            };

            const { error } = await signUp(email, password, metadata);
            if (error) alert("Signup failed: " + error.message);
            else {
                alert("Account created! Please check your email to verify.");
                signupBackdrop.style.display = "none";
            }
        });
    </script>
</body>
</html>
