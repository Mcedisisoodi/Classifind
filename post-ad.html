<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Post Ad ‚Äì HoneySweetpot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <script type="module" src="app.js"></script>
</head>
<body>
    <header>
        <div class="logo"><a href="index.html" style="text-decoration:none; color:inherit;">Honey<span>Sweetpot</span> <img src="public/categories/HoneyPot.png" alt="HoneySweetpot Logo" style="height: 60px; vertical-align: bottom; margin-left: 5px;"></a></div>
        <div class="header-actions">
            <button class="btn" id="loginBtn">Login</button>
            <button class="btn" id="signupBtn">Sign up</button>
            <!-- Post Ad button hidden on this page or disabled -->
        </div>
    </header>
    <main>
        <div class="post-ad-container">
            <div class="postad-header">
                <h2>Post an Ad</h2>
            </div>
            <div class="postad-body">
                <label for="postCategory">Category</label>
                <select id="postCategory">
                    <option value="">Select category</option>
                    <option value="Cars">Cars</option>
                    <option value="Phones">Phones & Tablets</option>
                    <option value="Property">Property</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Fashion & Beauty">Fashion & Beauty</option>
                    <option value="Jobs">Jobs</option>
                    <option value="Other">Other</option>
                </select>

                <label for="postTitle">Ad title</label>
                <input id="postTitle" type="text" placeholder="e.g. VW Polo 1.4 Trendline, excellent condition" />

                <label for="postDescription">Description</label>
                <textarea id="postDescription" placeholder="Describe the item, condition, mileage, features, etc."></textarea>

                <label for="postPrice">Price (R)</label>
                <input id="postPrice" type="number" min="0" placeholder="e.g. 145000" />

                <label for="postCondition">Condition</label>
                <select id="postCondition">
                    <option value="New">New</option>
                    <option value="Used" selected>Used</option>
                    <option value="Needs Repair">Needs Repair</option>
                </select>

                <label for="postLocation">Location (Town / City)</label>
                <input id="postLocation" type="text" placeholder="e.g. Klerksdorp, Johannesburg, Cape Town" />

                <label for="postSellerName">Your name</label>
                <input id="postSellerName" type="text" placeholder="Your name or business" />

                <label for="postContact">Contact (phone / email)</label>
                <input id="postContact" type="text" placeholder="e.g. 072 123 4567 or you@example.com" />

                <label for="postImageUrl">Image URL (optional)</label>
                <input id="postImageUrl" type="url" placeholder="Paste an image link (jpg, png...)" />

                <label>Upload images</label>
                <div class="upload-buttons-row">
                    <label class="btn-upload-custom">
                        <span>üñºÔ∏è Gallery</span>
                        <input id="postImageFiles" type="file" accept="image/*" multiple hidden />
                    </label>
                    <label class="btn-upload-custom">
                        <span>üì∑ Camera</span>
                        <input id="postCameraInput" type="file" accept="image/*" capture="environment" hidden />
                    </label>
                </div>
                <div id="imagePreviewContainer" class="image-preview-grid"></div>
                <p class="postad-note">You can upload multiple photos. The first one will be the main cover image.</p>

                <button class="postad-submit" id="postAdSubmit">Post Ad</button>
            </div>
        </div>
    </main>

    <!-- Auth Modals -->
    <div class="auth-backdrop" id="loginBackdrop">
        <div class="auth-modal">
            <div class="auth-header">
                <h2>Login</h2>
                <button class="auth-close" id="loginClose">&times;</button>
            </div>
            <div class="auth-body">
                <label for="loginEmail">Email or Phone</label>
                <input id="loginEmail" type="text" placeholder="you@example.com" />
                <label for="loginPassword">Password</label>
                <input id="loginPassword" type="password" placeholder="Enter your password" />
                <button class="auth-submit" id="loginSubmit">Login</button>
                <div class="auth-actions">
                    <span id="forgotPassword" class="auth-link" style="font-size:0.8rem;">Forgot Password?</span>
                    <span>New here? <span id="goToSignup" class="auth-link">Create an account</span></span>
                </div>
            </div>
        </div>
    </div>

    <div class="auth-backdrop" id="signupBackdrop">
        <div class="auth-modal">
            <div class="auth-header">
                <h2>Sign up</h2>
                <button class="auth-close" id="signupClose">&times;</button>
            </div>
            <div class="auth-body">
                <label for="signupName">Name</label>
                <input id="signupName" type="text" placeholder="First Name" />
                <label for="signupSurname">Surname</label>
                <input id="signupSurname" type="text" placeholder="Last Name" />
                <label for="signupAddress">Address</label>
                <input id="signupAddress" type="text" placeholder="Your Address" />
                <label for="signupPhone">Phone Number</label>
                <input id="signupPhone" type="tel" placeholder="072 123 4567" />
                <label for="signupEmail">Email</label>
                <input id="signupEmail" type="email" placeholder="you@example.com" />
                
                <label>I am a:</label>
                <select id="signupRole">
                    <option value="buyer">Buyer</option>
                    <option value="seller">Seller</option>
                </select>

                <div id="bankDetailsSection" class="hidden">
                    <label for="signupBank">Bank Account Details</label>
                    <textarea id="signupBank" placeholder="Bank Name, Account Number, Branch Code" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;"></textarea>
                </div>

                <div class="field-group">
                    <label for="signupPassword">Password</label>
                    <input id="signupPassword" type="password" placeholder="Create a password" />
                </div>
                <div class="field-group">
                    <label for="signupPasswordConfirm">Confirm Password</label>
                    <input id="signupPasswordConfirm" type="password" placeholder="Re-enter password" />
                </div>

                <button class="auth-submit" id="signupSubmit">Create account</button>
                <div class="auth-actions">
                    <span>Already have an account? <span id="goToLogin" class="auth-link">Login</span></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabaseClient, getSession, signIn, signUp, resetPassword } from './app.js';

        // Auth Modal Logic
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const loginBackdrop = document.getElementById("loginBackdrop");
        const signupBackdrop = document.getElementById("signupBackdrop");
        const loginClose = document.getElementById("loginClose");
        const signupClose = document.getElementById("signupClose");
        const goToSignup = document.getElementById("goToSignup");
        const goToLogin = document.getElementById("goToLogin");
        const forgotPassword = document.getElementById("forgotPassword");
        const signupRole = document.getElementById("signupRole");
        const bankDetailsSection = document.getElementById("bankDetailsSection");

        if(loginBtn) loginBtn.addEventListener("click", () => loginBackdrop.style.display = "flex");
                if(signupBtn) signupBtn.addEventListener("click", () => {
            signupBackdrop.style.display = "flex";
            // Reset form state
            if(signupRole) signupRole.value = "buyer";
            if(bankDetailsSection) bankDetailsSection.classList.add("hidden");
        });
        if(loginClose) loginClose.addEventListener("click", () => loginBackdrop.style.display = "none");
        if(signupClose) signupClose.addEventListener("click", () => signupBackdrop.style.display = "none");
        
        if(goToSignup) goToSignup.addEventListener("click", () => {
            loginBackdrop.style.display = "none";
            signupBackdrop.style.display = "flex";
            // Reset form state
            if(signupRole) signupRole.value = "buyer";
            if(bankDetailsSection) bankDetailsSection.classList.add("hidden");
        });
        if(goToLogin) goToLogin.addEventListener("click", () => {
            signupBackdrop.style.display = "none";
            loginBackdrop.style.display = "flex";
        });

        if(signupRole) {
            signupRole.addEventListener("change", () => {
                if(signupRole.value === "seller") {
                    bankDetailsSection.classList.remove("hidden");
                } else {
                    bankDetailsSection.classList.add("hidden");
                }
            });
        }

        if(forgotPassword) {
            forgotPassword.addEventListener("click", async () => {
                const email = prompt("Please enter your email address to reset your password:");
                if(email) {
                    const { error } = await resetPassword(email);
                    if(error) alert("Error: " + error.message);
                    else alert("Password reset link sent to " + email);
                }
            });
        }

        // Auth Submit Logic
        document.getElementById("loginSubmit").addEventListener("click", async () => {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            const { error } = await signIn(email, password);
            if (error) alert("Login failed: " + error.message);
            else {
                loginBackdrop.style.display = "none";
            }
        });

        document.getElementById("signupSubmit").addEventListener("click", async () => {
            const email = document.getElementById("signupEmail").value;
            const password = document.getElementById("signupPassword").value;
            const confirm = document.getElementById("signupPasswordConfirm").value;
            
            if(password !== confirm) {
                alert("Passwords do not match!");
                return;
            }

            const metadata = {
                first_name: document.getElementById("signupName").value,
                last_name: document.getElementById("signupSurname").value,
                address: document.getElementById("signupAddress").value,
                phone: document.getElementById("signupPhone").value,
                role: document.getElementById("signupRole").value,
                bank_details: document.getElementById("signupBank").value
            };

            const { error } = await signUp(email, password, metadata);
            if (error) alert("Signup failed: " + error.message);
            else {
                alert("Account created! Please check your email to verify.");
                signupBackdrop.style.display = "none";
            }
        });

        // Post Ad Logic
        const postAdSubmit = document.getElementById("postAdSubmit");
        const imageFileInput = document.getElementById("postImageFiles");
        const cameraInput = document.getElementById("postCameraInput");
        const imagePreviewContainer = document.getElementById("imagePreviewContainer");
        let selectedFiles = [];

        function handleFiles(files) {
            if (files.length > 0) {
                selectedFiles = [...selectedFiles, ...files];
                updateImagePreviews();
            }
        }

        if (imageFileInput) {
            imageFileInput.addEventListener("change", (e) => {
                handleFiles(Array.from(e.target.files));
                imageFileInput.value = ""; 
            });
        }

        if (cameraInput) {
            cameraInput.addEventListener("change", (e) => {
                handleFiles(Array.from(e.target.files));
                cameraInput.value = ""; 
            });
        }

        async function updateImagePreviews() {
            imagePreviewContainer.innerHTML = "";
            
            // Use Promise.all to ensure images are read and displayed in the correct order
            const readPromises = selectedFiles.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            });

            const results = await Promise.all(readPromises);

            results.forEach((src, index) => {
                const div = document.createElement("div");
                div.className = "preview-card";
                
                const img = document.createElement("img");
                img.src = src;
                
                const removeBtn = document.createElement("button");
                removeBtn.innerHTML = "&times;";
                removeBtn.className = "preview-remove";
                removeBtn.onclick = () => {
                    selectedFiles.splice(index, 1);
                    updateImagePreviews();
                };

                div.appendChild(img);
                div.appendChild(removeBtn);
                imagePreviewContainer.appendChild(div);
            });
        }
        
        // Auto-fill seller info if logged in
        getSession().then(session => {
            if (session && session.user) {
                const email = session.user.email;
                const meta = session.user.user_metadata;
                if (meta) {
                    const fullName = [meta.first_name, meta.last_name].filter(Boolean).join(" ");
                    if (fullName) document.getElementById("postSellerName").value = fullName;
                }
                document.getElementById("postContact").value = email;
            }
        });

        postAdSubmit.addEventListener("click", async () => {
            const category = document.getElementById("postCategory").value.trim();
            const title = document.getElementById("postTitle").value.trim();
            const description = document.getElementById("postDescription").value.trim();
            const price = document.getElementById("postPrice").value.trim();
            const condition = document.getElementById("postCondition").value;
            const location = document.getElementById("postLocation").value.trim();
            const sellerName = document.getElementById("postSellerName").value.trim();
            const contact = document.getElementById("postContact").value.trim();
            const imageUrlInput = document.getElementById("postImageUrl").value.trim();

            if (!category || !title || !description || !location) {
                alert("Please fill in at least category, title, description, and location.");
                return;
            }

            postAdSubmit.disabled = true;
            postAdSubmit.textContent = "Posting...";

            let uploadedImageUrls = [];
            
            // 1. Upload files if any
            if (selectedFiles.length > 0) {
                try {
                    const uploadPromises = selectedFiles.map(async (file) => {
                        const fileExt = file.name.split(".").pop();
                        const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.${fileExt}`;
                        const filePath = `ads/${fileName}`;
                        
                        const { data, error } = await supabaseClient
                            .storage
                            .from("ad-images")
                            .upload(filePath, file);
                        
                        if (error) throw error;

                        const { data: publicUrlData } = supabaseClient
                            .storage
                            .from("ad-images")
                            .getPublicUrl(filePath);
                        
                        return publicUrlData.publicUrl;
                    });

                    uploadedImageUrls = await Promise.all(uploadPromises);

                } catch (storageError) {
                    console.error("Error uploading images:", storageError);
                    postAdSubmit.disabled = false;
                    postAdSubmit.textContent = "Post Ad";
                    if (storageError.message && storageError.message.includes("row-level security")) {
                        alert("Upload failed: Database permissions missing.\n\nPlease run the 'supabase_setup.sql' script in your Supabase Dashboard.");
                    } else {
                        alert("Failed to upload images: " + storageError.message);
                    }
                    return;
                }
            }

            // 2. Handle manual URL input (add to front if present)
            if (imageUrlInput) {
                // Validate URL format (basic check)
                if (imageUrlInput.match(/^https?:\/\//i) || imageUrlInput.match(/^data:image\//i)) {
                    uploadedImageUrls.unshift(imageUrlInput);
                } else {
                    console.warn("Skipping invalid image URL:", imageUrlInput);
                    // Optional: Alert user? Maybe not to block flow, but good to know.
                }
            }

            // Filter out any empty or null URLs to prevent "empty" images
            uploadedImageUrls = uploadedImageUrls.filter(url => url && url.trim() !== "");

            // 3. Prepare data
            // Primary image is the first one
            const primaryImage = uploadedImageUrls.length > 0 ? uploadedImageUrls[0] : null;

            const { data, error } = await supabaseClient
                .from("ads")
                .insert({
                    title,
                    description,
                    category,
                    price: price ? Number(price) : null,
                    condition,
                    location,
                    seller_name: sellerName || null,
                    contact: contact || null,
                    image_url: primaryImage, // Keep for backward compatibility
                    images: uploadedImageUrls // New JSONB column
                })
                .select()
                .single();

            if (error) {
                console.error("Error inserting ad:", error);
                postAdSubmit.disabled = false;
                postAdSubmit.textContent = "Post Ad";
                if (error.message.includes("row-level security")) {
                    alert("Post failed: Database permissions missing.\n\nPlease run the 'supabase_setup.sql' script in your Supabase Dashboard.");
                } else {
                    alert("Could not save your ad: " + error.message);
                }
                return;
            }

            alert("Your ad has been posted! Redirecting to home...");
            window.location.href = "index.html";
        });
    </script>
</body>
</html>
